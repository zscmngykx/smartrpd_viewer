name: Frontend CI/CD to AWS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æ‹‰å–ä»£ç 
        uses: actions/checkout@v3

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
          npm install

      - name: ğŸ”“ ä¿®å¤ webpack æ‰§è¡Œæƒé™
        run: |
          echo "ğŸ”“ ä¿®å¤ webpack æ‰§è¡Œæƒé™..."
          chmod +x node_modules/.bin/webpack || true

      - name: ğŸ› ï¸ æ„å»º ThreeDViewer.bundle.js
        run: |
          echo "ğŸ› ï¸ æ‰§è¡Œ npm run build..."
          npm run build
          echo "ğŸ“‚ æŸ¥çœ‹ dist/ ç›®å½•æ‰“åŒ…ç»“æœï¼š"
          ls -lh dist/

      - name: ğŸ§¹ æ¸…ç†è¿œç¨‹éƒ¨ç½²ç›®å½•
        run: |
          echo "ğŸ§¹ æ¸…ç†æ—§éƒ¨ç½²ç›®å½•å¹¶èµ‹æƒ..."
          echo "${{ secrets.EC2_SSH_KEY }}" > private_key.pem
          chmod 600 private_key.pem
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} '
            sudo rm -rf /var/www/html/* &&
            sudo mkdir -p /var/www/html &&
            sudo chown -R $USER:$USER /var/www/html
          '

      - name: ğŸ“¤ ä¸Šä¼ æ‰€æœ‰é™æ€æ–‡ä»¶ï¼ˆä¿ç•™ src è·¯å¾„ç»“æ„ï¼‰
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: |
            index.html
            css/**
            assets/**
            dist/bundle.js
            src/**
          target: /var/www/html/
          strip_components: 0


      - name: âœ… è¾“å‡ºè®¿é—®é“¾æ¥
        run: |
          echo 'âœ… éƒ¨ç½²å®Œæˆï¼Œè¯·è®¿é—®ï¼š'
          echo 'ğŸ”— http://${{ secrets.EC2_HOST }}/index.html'
          echo 'ğŸ”— http://${{ secrets.EC2_HOST }}/src/pages/case_list.html'
          echo 'ğŸ”— http://${{ secrets.EC2_HOST }}/src/pages/ThreeDViewer.html'
        if: success()

      - name: âŒ æ„å»ºå¤±è´¥æç¤º
        run: echo 'âŒ æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—'
        if: failure()
