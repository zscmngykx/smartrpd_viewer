name: Frontend CI/CD to AWS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æ‹‰å–ä»£ç 
        uses: actions/checkout@v3

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
          npm install

      - name: ğŸ”“ ä¿®å¤ webpack æ‰§è¡Œæƒé™
        run: |
          echo "ğŸ”“ ä¿®å¤ webpack æ‰§è¡Œæƒé™..."
          chmod +x node_modules/.bin/webpack || true

      - name: ğŸ› ï¸ æ„å»º ThreeDViewer.bundle.js
        run: |
          echo "ğŸ› ï¸ æ‰§è¡Œ npm run build..."
          npm run build
          echo "ğŸ“‚ æ„å»ºè¾“å‡ºå†…å®¹ï¼š"
          ls -lh dist/
          echo "ğŸ“‚ src/pages å†…å®¹ï¼š"
          ls -lh src/pages || true
          echo "ğŸ“‚ css å†…å®¹ï¼š"
          ls -lh css || true
          echo "ğŸ“‚ assets å†…å®¹ï¼š"
          ls -lh assets || true
          echo "ğŸ“‚ src æ ¹ç›®å½•æ–‡ä»¶ï¼š"
          ls -lh src/*.js || true

      - name: ğŸ§¹ æ¸…ç†è¿œç¨‹éƒ¨ç½²ç›®å½•
        run: |
          echo "ğŸ§¹ æ¸…ç†æ—§éƒ¨ç½²ç›®å½•å¹¶èµ‹æƒ..."
          echo "${{ secrets.EC2_SSH_KEY }}" > private_key.pem
          chmod 600 private_key.pem
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} '
            sudo rm -rf /var/www/html/* &&
            sudo mkdir -p /var/www/html &&
            sudo chown -R $USER:$USER /var/www/html
          '

      - name: ğŸ“¤ ä½¿ç”¨åŸç”Ÿ scp ä¸Šä¼ æ‰€æœ‰é™æ€èµ„æºï¼ˆå½»åº•ç¨³å®šï¼‰
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > private_key.pem
          chmod 600 private_key.pem

          echo "ğŸ“¦ ä¸Šä¼  index.html"
          scp -i private_key.pem -o StrictHostKeyChecking=no index.html ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/var/www/html/

          echo "ğŸ“¦ ä¸Šä¼  css/"
          scp -i private_key.pem -o StrictHostKeyChecking=no -r css ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/var/www/html/

          echo "ğŸ“¦ ä¸Šä¼  assets/"
          scp -i private_key.pem -o StrictHostKeyChecking=no -r assets ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/var/www/html/

          echo "ğŸ“¦ ä¸Šä¼  dist/bundle.js"
          # âœ… å…ˆåœ¨ EC2 ä¸Šåˆ›å»º /dist ç›®å½•
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'mkdir -p /var/www/html/dist'

            # ğŸ“¦ ä¸Šä¼  bundle.js åˆ° /dist/
          scp -i private_key.pem -o StrictHostKeyChecking=no dist/bundle.js ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/var/www/html/dist/


          echo "ğŸ“¦ ä¸Šä¼  src/"
          scp -i private_key.pem -o StrictHostKeyChecking=no -r src ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/var/www/html/



      - name: ğŸ“ æ˜¾ç¤º EC2 ä¸Šéƒ¨ç½²ç»“æœ
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > private_key.pem
          chmod 600 private_key.pem
          echo "ğŸ“ æŸ¥çœ‹è¿œç¨‹ /var/www/html/ ç»“æ„ï¼š"
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'ls -R /var/www/html/'

      - name: âœ… è¾“å‡ºè®¿é—®é“¾æ¥
        run: |
          echo 'âœ… éƒ¨ç½²å®Œæˆï¼Œè¯·è®¿é—®ï¼š'
          echo 'ğŸ”— http://${{ secrets.EC2_HOST }}/index.html'
          echo 'ğŸ”— http://${{ secrets.EC2_HOST }}/src/pages/case_list.html'
          echo 'ğŸ”— http://${{ secrets.EC2_HOST }}/src/pages/ThreeDViewer.html'
        if: success()

    #   - name: ğŸ“ æŸ¥çœ‹ EC2 ä¸Šçš„ dist ç›®å½•å†…å®¹
    #     run: |
    #       echo "${{ secrets.EC2_SSH_KEY }}" > private_key.pem
    #       chmod 600 private_key.pem
    #       ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} '
    #         echo "âœ… dist ç›®å½•å†…å®¹ï¼š"
    #         ls -lh /var/www/html/dist
    #       '
      
      - name: âŒ æ„å»ºå¤±è´¥æç¤º
        run: echo 'âŒ æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—'
        if: failure()
